import os
import sys
import subprocess
import platform
import uuid
import menu_config
from SCons.Script import *

# Get project root directory (parent of win32_sim)
PROJECT_ROOT = os.path.dirname(os.getcwd())
TOOL_ROOT = os.path.join(PROJECT_ROOT, 'tool/scons-tool')

sys.path.append(TOOL_ROOT)
try:
    from building import *
except:
    print('Cannot found Scons tool root directory, please check TOOL_ROOT')
    exit(-1)

TARGET = 'gui.exe' if sys.platform == 'win32' else 'gui'
print(f"Platform: {sys.platform}, TARGET: {TARGET}")

# Environment setup
env_params = {
    'CC': menu_config.CC,
    'CFLAGS': menu_config.CFLAGS,
    'CXX': menu_config.CXX,
    'CXXFLAGS': menu_config.CXXFLAGS,
    'LINKFLAGS': menu_config.LFLAGS
}

if sys.platform == 'win32':
    env = Environment(tools=['mingw'], **env_params)
else:
    env = Environment(tools=['default'], PROGSUFFIX='', **env_params)

RTK_GUI_ENGINE = os.path.join(PROJECT_ROOT, 'realgui')
GUI_EXAMPLE = os.path.join(PROJECT_ROOT, 'example')
GUI_SIM_LIBS = os.path.join(PROJECT_ROOT, 'lib/sim')
PLATFORM = menu_config.PLATFORM

Export('PLATFORM', 'TOOL_ROOT', 'RTK_GUI_ENGINE', 'env')

print("CC:", env['CC'])
print("CFLAGS:", env['CFLAGS'])
print("CXXFLAGS:", env['CXXFLAGS'])
print("LINKFLAGS:", env['LINKFLAGS'])
print('TOOL ROOT =', TOOL_ROOT)
print('RTK GUI ENGINE ROOT =', RTK_GUI_ENGINE)

def compile_resource(rc_file, output_file):
    try:
        subprocess.run(['windres', rc_file, '-O', 'coff', '-o', output_file], check=True)
        print(f'Successfully compiled {rc_file} to {output_file}')
    except subprocess.CalledProcessError as e:
        print(f'An error occurred: {e}')
    except FileNotFoundError:
        print('windres command not found. Ensure MinGW is installed and windres is in the system PATH.')

# Prepare building environment
objs = PrepareBuilding(env, TOOL_ROOT, has_libcpu=False)

# Compile resource file on Windows
if sys.platform == 'win32':
    compile_resource('version.rc', 'version.o')
    objs.append('version.o')

# Set spawn: save & load long param as temp file
def ourspawn(sh, escape, cmd, args, e):
    filename = str(uuid.uuid4())
    cmdline = cmd + " " + ' '.join(args[1:])
    if len(cmdline) > 16 * 1024:
        with open(filename, 'w') as f:
            f.write(' '.join(args[1:]).replace('\\', '/'))
        cmdline = cmd + " @" + filename
    
    proc = subprocess.Popen(cmdline, stdin=subprocess.PIPE, stdout=subprocess.PIPE,
                           stderr=subprocess.PIPE, shell=False, env=e)
    data, err = proc.communicate()
    rv = proc.wait()
    
    def res_output(_output, _s):
        if len(_s):
            if isinstance(_s, str):
                _output(_s)
            elif isinstance(_s, bytes):
                _output(str(_s, 'UTF-8'))
            else:
                _output(str(_s))
    
    res_output(sys.stderr.write, err)
    res_output(sys.stdout.write, data)
    if os.path.isfile(filename):
        os.remove(filename)
    return rv

if sys.platform == 'win32':
    env['SPAWN'] = ourspawn

# Include app SConscripts
for path in [RTK_GUI_ENGINE, GUI_EXAMPLE, GUI_SIM_LIBS]:
    sconscript = os.path.join(path, 'SConscript')
    if os.path.exists(sconscript):
        objs.extend(SConscript(sconscript))

# Platform-specific libraries
if sys.platform == 'win32':
    env.Append(LIBS=[
        'mingw32', 'SDL2main', 'SDL2', 'user32', 'gdi32', 'winmm',
        'imm32', 'ole32', 'oleaut32', 'version', 'uuid', 'advapi32',
        'setupapi', 'shell32', 'dinput8', 'opengl32', 'm'
    ])
else:  # Linux/WSL
    env.Append(LIBS=['SDL2', 'GL', 'pthread', 'm', 'dl'])

# Build
DoBuilding(TARGET, objs)
